#!/bin/bash

# Setting up the environment to build everything - download packages, build them, etc.

# Bolierplate reduction.
function clonepull {
    git clone $1 $2 || (cd $2 ; git pull) || exit 1
}

# Location of script files.
export SCRIPT_DIR=`pwd`

# The root dir is a level above SKA-RC root.
export MS7_DIR="`pwd`/../.."
export ROOT="`pwd`/../../../.."

# The directory to have all builds in. Easier to clean.
export BUILDDIR="$ROOT/build"
mkdir -p $BUILDDIR

# Going to the root.
cd $BUILDDIR

# -- LLVM ----------------------------------------------------------------------
# Download and build LLVM.

# Download LLVM.
$SCRIPT_DIR/dl-llvm.sh || exit 1

# Build LLVM.
$SCRIPT_DIR/mk-llvm.sh || exit 1

# Provide one true LLVM.
export LLVM_BIN=$BUILDDIR/llvm-install/bin
export PATH=$LLV_BIN:$PATH
export LLVM_CONFIG=$PWD/llvm-install/bin/llvm-config

# -- GASnet --------------------------------------------------------------------
# Right now GASnet does not seem to be available in any modules on cluster.

cd $BUILDDIR

# getting GASnet. We use our GASNet version, cloned from Stanford Legion repo -
# it has config for the Cambridge cluster.
# It enables MPI, UDP (for local run), IBV (for cluster), disables MXM
# (also available on cluster).
clonepull https://github.com/SKA-ScienceDataProcessor/gasnet.git gasnet

# Build it for default config - cambridge-wilkes-ibv.
cd gasnet
make
cd ..

export GASNET_ROOT="$PWD/gasnet/release"
export GASNET_BIN="$GASNET_ROOT/bin"

# -- Terra ---------------------------------------------------------------------
# Terra also unavailable on cluster.

clonepull https://github.com/zdevito/terra.git terra

cd terra

# Known good commit.
git checkout c501af43915


make all || exit 1
cd ..

export TERRA_DIR=$BUILDDIR/terra/release

# -- Legion --------------------------------------------------------------------
# Legion build structure is such that we cannot easily build
# and install libraries/header files somewhere.
# Executables/libraries build with IBV conduit may or may not use UDP conduit.
# So we build two versions separately.

clonepull https://github.com/SKA-ScienceDataProcessor/legion.git Legion-udp
clonepull Legion-udp Legion-ibv

# Go to Regent place.
cd Legion-udp/language

# Running the installation, enabling the GASnet.
CONDUIT=udp ./install.py --with-terra=$TERRA_DIR --gasnet || exit 1

# Up from Regent.
cd $BUILDDIR

# Go to Regent place.
cd Legion-ibv/language

# Running the installation, enabling the GASnet.
CONDUIT=ibv ./install.py --with-terra=$TERRA_DIR --gasnet || exit 1

# Up from Regent.
cd $BUILDDIR

cat >$SCRIPT_DIR/build-rules.mk <<EOF
# AUTOGENERATED FILE!!!!
# Makefile include file to provide "compilation" for local runs of Regent files.
# Defines implicit rule to compile executable ("make" or "make exec") and cleanup rule ("make clean").
# Runs first executable (in EXEC list below) by "make run" and any executable using "make run-EXECUTABLE".
# Use in Makefile like the following:
# -------------------------------------
# # Makefile example:
#
# # Set executable name (myprog-upd and myprog-ibv will be built):
# EXEC=myprog
#
# # Sources to build from:
# SRCS= a.cc b.cc main.cc
#
# # All rules needed are provided by makefile.inc (which you read right now).
# include ../../scripts/makefile.inc
# -------------------------------------

# Set nodes counter if none given to 1.
NODES ?= 1

# Set task counter if none given to 1.
TASKS ?= 1

# Set threads count per task to 1 if none given.
THREADS ?= 1

# We do not provide default values for:
#  - memory bounds (TASKMB, set to be empty - no bounds needed)
#  - GPU accelerator type (GPU)
#  - network conduit (NET)

all: \$(EXEC)

help:
	echo "Available targets: help (this text), exec (will build $(EXEC)), run, clean"

run: \$(EXEC)
	./\${word 1, \$(EXEC)} -nodes=\$(NODES) -tasks=\$(TASKS) -threads=\$(THREADS) -mem=\$(TASKMB) -gpu=\$(GPU) -net=\$(NET) \$(EXEC_ARGS)

clean:
	rm -f \$(EXEC)

\$(EXEC): \$(SRCS)

EOF